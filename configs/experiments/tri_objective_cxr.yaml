# Tri-Objective Training Configuration - Chest X-Ray (Multi-Label)
# NIH ChestX-ray14 - Phase 7.6
# =============================================================================
# Research Question: RQ1 (Robustness + Generalization) + RQ2 (Explainability)
# Target: A1+ Grade, Publication-Ready
#
# Mathematical Formulation:
#   L_total = L_task + λ_rob * L_rob + λ_expl * L_expl
#
# Where (Multi-Label Adaptations):
#   - L_task: Binary Cross-Entropy with Focal Loss (class imbalance)
#   - L_rob: TRADES with KL divergence on sigmoid outputs
#   - L_expl: SSIM stability + TCAV concept grounding (same as dermoscopy)
#
# Target Performance (A1+ Grade Criteria):
#   - Macro AUROC (clean): ≥ 0.76
#   - Macro AUROC (robust): ≥ 0.65
#   - Cross-Site AUROC Drop: ≤ 0.10
#   - SSIM Stability: ≥ 0.75
#   - Artifact TCAV: ≤ 0.20
#   - Medical TCAV: ≥ 0.68
#   - Hamming Loss: ≤ 0.15
#   - ECE: ≤ 0.10
#
# Author: Viraj Pankaj Jain
# Institution: University of Glasgow
# Date: November 27, 2025
# =============================================================================

experiment:
  name: "tri_objective_resnet50_nih_cxr"
  description: "Tri-objective adversarial training for multi-label chest X-ray classification"
  task: "tri_objective_multilabel_classification"
  tags:
    - "tri-objective"
    - "chest-xray"
    - "nih-cxr"
    - "multi-label"
    - "phase-7.6"
    - "publication"
  author: "Viraj Pankaj Jain"
  notes: |
    Phase 7.6: Multi-label adaptation of tri-objective framework.
    Key changes: BCE/Focal loss, sigmoid activation, multi-label metrics.
    XAI components remain architecture-agnostic (same as dermoscopy).

# Model Configuration
model:
  architecture: "resnet50"
  pretrained: true
  num_classes: 14  # NIH ChestX-ray14: 14 disease labels
  dropout: 0.3
  multilabel: true  # Enable sigmoid instead of softmax

  # Feature extraction layers for XAI
  feature_layers:
    - "layer2"
    - "layer3"
    - "layer4"  # Primary layer for Grad-CAM and TCAV

# Dataset Configuration
dataset:
  name: "nih_cxr"
  root_dir: "data/processed/nih_cxr"
  image_size: 224
  task_type: "multi-label"

  # 14 disease classes (NIH ChestX-ray14)
  class_names:
    - "Atelectasis"
    - "Cardiomegaly"
    - "Effusion"
    - "Infiltration"
    - "Mass"
    - "Nodule"
    - "Pneumonia"
    - "Pneumothorax"
    - "Consolidation"
    - "Edema"
    - "Emphysema"
    - "Fibrosis"
    - "Pleural_Thickening"
    - "Hernia"

  # Positive rates per class (from training set statistics)
  # Used for focal loss weighting
  positive_rates: [0.103, 0.025, 0.119, 0.177, 0.051, 0.056, 0.012, 0.047, 0.041, 0.020, 0.022, 0.015, 0.030, 0.002]

  # Data splits
  splits:
    train: 0.7
    val: 0.15
    test: 0.15

  # Augmentation strategy (conservative for CXR)
  augmentation:
    train:
      - name: "RandomResizedCrop"
        size: 224
        scale: [0.9, 1.0]  # Less aggressive than dermoscopy
      - name: "HorizontalFlip"
        p: 0.5
      - name: "RandomRotation"
        degrees: 10  # Small rotation to preserve anatomy
      - name: "ColorJitter"
        brightness: 0.1
        contrast: 0.1
      - name: "Normalize"
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]

    val_test:
      - name: "Resize"
        size: 256
      - name: "CenterCrop"
        size: 224
      - name: "Normalize"
        mean: [0.485, 0.456, 0.406]
        std: [0.229, 0.224, 0.225]

# Tri-Objective Loss Configuration
loss:
  # Task Loss (L_task) - Multi-Label
  task:
    type: "bce_with_logits"
    use_focal: true
    focal_gamma: 2.0
    focal_alpha: 0.25
    pos_weight: "auto"  # Computed from positive_rates
    label_smoothing: 0.0
    reduction: "mean"

  # Robustness Loss (L_rob) - TRADES (adapted for multi-label)
  robustness:
    type: "trades"
    beta: 6.0
    epsilon: 0.01569  # 4/255 (smaller for CXR)
    pgd_steps: 7
    pgd_step_size: 0.00392  # epsilon / 4
    pgd_random_start: true
    norm: "Linf"

  # Explanation Loss (L_expl) - Same as dermoscopy
  explanation:
    # Stability component
    stability:
      type: "ssim"
      epsilon_adv: 0.00392  # 1/255 (very small for CXR)
      attack_type: "fgsm"
      data_range: 1.0

    # Concept component
    concept:
      artifact_concepts:
        - "text_overlay"
        - "black_borders"
        - "patient_markers"
        - "blank_regions"

      medical_concepts:
        - "lung_opacity"
        - "cardiac_silhouette"
        - "rib_shadows"
        - "diaphragm"

      artifact_threshold: 0.3
      medical_threshold: 0.5
      medical_weight: 0.5
      cav_layer: "layer4"
      precomputed_cavs: "data/concepts/chest_xray/cavs/"

    gamma: 0.5  # Balances SSIM and TCAV

  # Overall tri-objective weights (from Phase 7.4 HPO)
  lambda_rob: 0.3
  lambda_expl: 0.1

# Training Configuration
training:
  num_epochs: 60
  batch_size: 32
  num_workers: 4
  pin_memory: true

  optimizer:
    type: "adamw"
    lr: 0.0001
    weight_decay: 0.01
    betas: [0.9, 0.999]
    eps: 1.0e-08

  scheduler:
    type: "cosine"
    T_max: 60
    eta_min: 1.0e-06
    warmup_epochs: 5
    warmup_start_lr: 1.0e-06

  gradient_clip_norm: 1.0
  gradient_accumulation_steps: 1
  mixed_precision: true

  early_stopping:
    enabled: true
    patience: 15
    metric: "val_combined_score"
    mode: "max"
    min_delta: 0.001

# Validation Configuration
validation:
  eval_every_n_epochs: 1

  metrics:
    - "macro_auroc"
    - "micro_auroc"
    - "per_class_auroc"
    - "hamming_loss"
    - "subset_accuracy"
    - "f1_macro"
    - "f1_micro"
    - "robust_macro_auroc"
    - "ssim_stability"
    - "artifact_tcav"
    - "medical_tcav"
    - "ece"

  adversarial_eval:
    epsilon: 0.01569  # 4/255
    steps: 10
    step_size: 0.00392
    attack_type: "pgd"

  classification_threshold: 0.5
  optimize_threshold: true  # Optimize per-class thresholds

# Checkpointing Configuration
checkpointing:
  save_dir: "results/checkpoints/tri_objective_cxr"
  save_every_n_epochs: 5
  save_best_only: false

  save_components:
    - "model_state_dict"
    - "optimizer_state_dict"
    - "scheduler_state_dict"
    - "epoch"
    - "metrics"
    - "config"
    - "class_thresholds"

  checkpoint_format: "tri_obj_resnet50_nih_cxr_epoch{epoch:03d}_seed{seed}.pt"
  best_checkpoint_format: "tri_obj_resnet50_nih_cxr_best_seed{seed}.pt"

# MLflow Configuration
mlflow:
  tracking_uri: "mlruns"
  experiment_name: "Tri-Objective-XAI-ChestXRay"
  run_name_format: "tri_obj_resnet50_nih_cxr_seed{seed}"

  log_params: true
  log_metrics: true
  log_artifacts: true
  log_model: true
  log_every_n_batches: 50

  artifacts:
    - "config"
    - "training_curves"
    - "heatmaps"
    - "checkpoints"
    - "per_class_performance"

# Monitoring Configuration
monitoring:
  tensorboard:
    enabled: false
  progress_bar: true
  track_loss_components: true

  loss_components:
    - "loss_task"
    - "loss_robustness"
    - "loss_stability"
    - "loss_concept"
    - "loss_total"

  plot_curves:
    - "train_loss"
    - "val_loss"
    - "val_macro_auroc"
    - "val_micro_auroc"
    - "val_robust_macro_auroc"
    - "val_ssim"
    - "val_artifact_tcav"
    - "val_medical_tcav"
    - "val_hamming_loss"

# Reproducibility Configuration
reproducibility:
  deterministic: true
  benchmark: false
  seed: 42

# Hardware Configuration
hardware:
  device: "cuda"
  cuda_device_ids: [0]
  empty_cache_every_n_batches: 100

# Expected Performance Targets (A1+ Grade)
expected_results:
  macro_auroc_min: 0.76
  robust_macro_auroc_min: 0.65
  cross_site_auroc_drop_max: 0.10
  ssim_min: 0.75
  artifact_tcav_max: 0.20
  medical_tcav_min: 0.68
  hamming_loss_max: 0.15
  ece_max: 0.10

# Experiment Variants
variants:
  seeds: [42, 123, 456]
  lambda_rob_variants: [0.3]
  lambda_expl_variants: [0.1]
